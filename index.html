<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎤 Ovoz Yozish va FIR Filtrlash</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a5f3c 0%, #2d4a35 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #1a5f3c;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #2d4a35;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #fffef0;
            border-radius: 15px;
            border: 2px solid #d4c5a0;
        }

        .section-title {
            font-size: 1.5em;
            color: #1a5f3c;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-label {
            width: 200px;
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }

        .form-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #1a5f3c;
        }

        select.form-input {
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 15px 25px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-record {
            background: linear-gradient(135deg, #1a5f3c 0%, #2d7a4d 100%);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: white;
        }

        .btn-filter {
            background: linear-gradient(135deg, #2d7a4d 0%, #3a9f5f 100%);
            color: white;
        }

        .btn-reset {
            background: linear-gradient(135deg, #d4a574 0%, #c9a368 100%);
            color: white;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            padding: 15px;
            background: #f0ead6;
            border-radius: 10px;
            color: #2d4a35;
            font-weight: 600;
            margin-top: 15px;
        }

        .audio-player {
            width: 100%;
            margin: 15px 0;
            border-radius: 10px;
        }

        .canvas-container {
            margin: 20px 0;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .audio-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .audio-box {
            padding: 20px;
            background: #fffef0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .audio-box h3 {
            color: #1a5f3c;
            margin-bottom: 15px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .audio-comparison {
                grid-template-columns: 1fr;
            }
            
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-label {
                width: 100%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎤 Ovoz Yozish va FIR Filtrlash</h1>
        <p class="subtitle">Ovoz yozing, tinglang va turli FIR filtrlar bilan qayta ishlang</p>

        <div class="section">
            <div class="section-title">📝 1. Ovoz Yozish</div>
            
            <div class="form-group">
                <label class="form-label">📂 Fayl nomi:</label>
                <input type="text" class="form-input" id="filename" value="signal_fayli">
            </div>

            <div class="button-group">
                <button class="btn-record" id="startBtn">🎤 Yozishni boshlash</button>
                <button class="btn-stop" id="stopBtn" disabled>🛑 To'xtatish</button>
            </div>

            <div class="status" id="recordStatus">⏳ Tayyor...</div>

            <div id="audioPlayerDiv" class="hidden">
                <h3 style="color: #1a5f3c; margin: 20px 0 10px 0;">🎧 Yozilgan ovoz:</h3>
                <audio id="audioPlayer" class="audio-player" controls></audio>
            </div>
        </div>

        <div class="section" id="filterSection" style="display: none;">
            <div class="section-title">🔧 2. FIR Filtr Sozlamalari</div>

            <div class="form-group">
                <label class="form-label">🎚️ Filtr turi:</label>
                <select class="form-input" id="filterType">
                    <option value="lowpass">🔽 Low-pass (Past chastotali)</option>
                    <option value="highpass">🔼 High-pass (Yuqori chastotali)</option>
                    <option value="bandpass">🎯 Band-pass (Tarmoqli)</option>
                    <option value="bandstop">🚫 Band-stop/Notch</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">📐 FIR dizayn usuli:</label>
                <select class="form-input" id="designMethod">
                    <option value="frequency">📊 Namunaviy chastota (Frequency Sampling)</option>
                    <option value="leastsquares">📉 Eng kichik kvadratlar (Least Squares)</option>
                    <option value="remez">🎯 Parks-McClellan (Remez Exchange)</option>
                    <option value="constrained">⚖️ Cheklangan kvadratik (Constrained LS)</option>
                    <option value="arbitrary">🔀 Ixtiyoriy javob (Arbitrary Response)</option>
                    <option value="raised">📈 Ko'tarilgan kosinus (Raised Cosine)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">🔢 Filtr tartibi:</label>
                <input type="number" class="form-input" id="filterOrder" value="51" min="3" max="501" step="2">
            </div>

            <div class="form-group" id="cutoffGroup">
                <label class="form-label">✂️ Kesish chastotasi (Hz):</label>
                <input type="number" class="form-input" id="cutoffFreq" value="1000" min="1">
            </div>

            <div class="form-group hidden" id="cutoffGroup2">
                <label class="form-label">✂️ Ikkinchi chastota (Hz):</label>
                <input type="number" class="form-input" id="cutoffFreq2" value="3000" min="1">
            </div>

            <div class="button-group">
                <button class="btn-filter" id="applyFilterBtn">🎨 Filtrni qo'llash</button>
                <button class="btn-reset" id="resetBtn">🔄 Qayta sinash</button>
            </div>

            <div class="status" id="filterStatus">⏳ Filtr parametrlarini tanlang...</div>
        </div>

        <div class="section results" id="resultsSection">
            <div class="section-title">📊 3. Natijalar va Taqqoslash</div>

            <div class="canvas-container">
                <canvas id="waveformChart"></canvas>
            </div>

            <div class="audio-comparison">
                <div class="audio-box">
                    <h3>🎵 Original Signal</h3>
                    <audio id="originalAudio" class="audio-player" controls></audio>
                </div>
                <div class="audio-box">
                    <h3>✨ Filtrlangan Signal</h3>
                    <audio id="filteredAudio" class="audio-player" controls></audio>
                </div>
            </div>

            <div class="canvas-container">
                <canvas id="spectrumChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        let audioContext;
        let audioBuffer;
        let originalAudioData;
        let sampleRate;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const recordStatus = document.getElementById('recordStatus');
        const audioPlayerDiv = document.getElementById('audioPlayerDiv');
        const audioPlayer = document.getElementById('audioPlayer');
        const filterSection = document.getElementById('filterSection');
        const filterType = document.getElementById('filterType');
        const cutoffGroup2 = document.getElementById('cutoffGroup2');
        const applyFilterBtn = document.getElementById('applyFilterBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultsSection = document.getElementById('resultsSection');
        const filterStatus = document.getElementById('filterStatus');

        // Filtr turi o'zgarganda
        filterType.addEventListener('change', () => {
            if (filterType.value === 'bandpass' || filterType.value === 'bandstop') {
                cutoffGroup2.classList.remove('hidden');
            } else {
                cutoffGroup2.classList.add('hidden');
            }
        });

        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayerDiv.classList.remove('hidden');
                    filterSection.style.display = 'block';
                    recordStatus.textContent = '✅ Yozish tugadi! Endi ovozni tinglang yoki filtrlang.';
                    
                    await loadAudioData();
                };

                mediaRecorder.start();
                startBtn.disabled = true;
                stopBtn.disabled = false;
                recordStatus.textContent = '🔴 Yozilmoqda... Gapiring!';
            } catch (err) {
                recordStatus.textContent = '❌ Xato: Mikrofonga ruxsat berilmadi!';
                console.error(err);
            }
        });

        stopBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            startBtn.disabled = false;
            stopBtn.disabled = true;
        });

        async function loadAudioData() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = await audioBlob.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                originalAudioData = audioBuffer.getChannelData(0);
                sampleRate = audioBuffer.sampleRate;
            } catch (err) {
                console.error('Audio yuklashda xato:', err);
            }
        }

        function designFIRFilter(order, cutoff, cutoff2, type, method, sr) {
            const M = order;
            const filter = new Array(M).fill(0);
            const wc = 2 * Math.PI * cutoff / sr;
            const wc2 = cutoff2 ? 2 * Math.PI * cutoff2 / sr : 0;
            const center = Math.floor(M / 2);

            for (let n = 0; n < M; n++) {
                if (n === center) {
                    if (type === 'lowpass') {
                        filter[n] = wc / Math.PI;
                    } else if (type === 'highpass') {
                        filter[n] = 1 - wc / Math.PI;
                    } else if (type === 'bandpass') {
                        filter[n] = (wc2 - wc) / Math.PI;
                    } else if (type === 'bandstop') {
                        filter[n] = 1 - (wc2 - wc) / Math.PI;
                    }
                } else {
                    const k = n - center;
                    if (type === 'lowpass') {
                        filter[n] = Math.sin(wc * k) / (Math.PI * k);
                    } else if (type === 'highpass') {
                        filter[n] = -Math.sin(wc * k) / (Math.PI * k);
                    } else if (type === 'bandpass') {
                        filter[n] = (Math.sin(wc2 * k) - Math.sin(wc * k)) / (Math.PI * k);
                    } else {
                        filter[n] = (Math.sin(wc * k) - Math.sin(wc2 * k)) / (Math.PI * k);
                    }
                }
                
                if (method === 'leastsquares' || method === 'constrained') {
                    filter[n] *= 0.42 - 0.5 * Math.cos(2 * Math.PI * n / (M - 1)) + 
                                  0.08 * Math.cos(4 * Math.PI * n / (M - 1));
                } else if (method === 'remez') {
                    const x = 2 * (n - center) / (M - 1);
                    filter[n] *= 0.402 + 0.498 * Math.cos(Math.PI * x) + 0.098 * Math.cos(2 * Math.PI * x);
                } else if (method === 'raised') {
                    filter[n] *= 0.5 * (1 - Math.cos(2 * Math.PI * n / (M - 1)));
                } else {
                    filter[n] *= 0.54 - 0.46 * Math.cos(2 * Math.PI * n / (M - 1));
                }
            }

            return filter;
        }

        function convolve(signal, filter) {
            const output = new Float32Array(signal.length);
            for (let i = 0; i < signal.length; i++) {
                let sum = 0;
                for (let j = 0; j < filter.length; j++) {
                    const idx = i - j;
                    if (idx >= 0 && idx < signal.length) {
                        sum += signal[idx] * filter[j];
                    }
                }
                output[i] = sum;
            }
            return output;
        }

        applyFilterBtn.addEventListener('click', () => {
            if (!originalAudioData) {
                filterStatus.textContent = '❌ Avval ovoz yozing!';
                return;
            }

            filterStatus.textContent = '⏳ Filtrlash jarayoni...';

            setTimeout(() => {
                try {
                    const order = parseInt(document.getElementById('filterOrder').value);
                    const cutoff = parseFloat(document.getElementById('cutoffFreq').value);
                    const cutoff2 = filterType.value === 'bandpass' || filterType.value === 'bandstop' 
                        ? parseFloat(document.getElementById('cutoffFreq2').value) 
                        : null;
                    const type = filterType.value;
                    const method = document.getElementById('designMethod').value;

                    const filter = designFIRFilter(order, cutoff, cutoff2, type, method, sampleRate);
                    const filteredData = convolve(originalAudioData, filter);

                    displayResults(originalAudioData, filteredData);
                    filterStatus.textContent = '✅ Filtrlash tugallandi!';
                } catch (err) {
                    filterStatus.textContent = '❌ Xato yuz berdi!';
                    console.error(err);
                }
            }, 100);
        });

        function displayResults(original, filtered) {
            resultsSection.classList.add('active');
            createAudioFromData(original, 'originalAudio');
            createAudioFromData(filtered, 'filteredAudio');
            drawWaveform(original, filtered);
            drawSpectrum(original, filtered);
        }

        function createAudioFromData(data, elementId) {
            const buffer = audioContext.createBuffer(1, data.length, sampleRate);
            buffer.copyToChannel(data, 0);
            
            const offlineContext = new OfflineAudioContext(1, data.length, sampleRate);
            const source = offlineContext.createBufferSource();
            source.buffer = buffer;
            source.connect(offlineContext.destination);
            source.start();
            
            offlineContext.startRendering().then(renderedBuffer => {
                const wav = audioBufferToWav(renderedBuffer);
                const blob = new Blob([wav], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                document.getElementById(elementId).src = url;
            });
        }

        function audioBufferToWav(buffer) {
            const length = buffer.length * buffer.numberOfChannels * 2;
            const wav = new ArrayBuffer(44 + length);
            const view = new DataView(wav);
            
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, buffer.numberOfChannels, true);
            view.setUint32(24, buffer.sampleRate, true);
            view.setUint32(28, buffer.sampleRate * buffer.numberOfChannels * 2, true);
            view.setUint16(32, buffer.numberOfChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length, true);
            
            const data = buffer.getChannelData(0);
            let offset = 44;
            for (let i = 0; i < data.length; i++) {
                const sample = Math.max(-1, Math.min(1, data[i]));
                view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                offset += 2;
            }
            
            return wav;
        }

        function drawWaveform(original, filtered) {
            const canvas = document.getElementById('waveformChart');
            const ctx = canvas.getContext('2d');
            
            if (window.waveChart) window.waveChart.destroy();
            
            const step = Math.ceil(original.length / 1000);
            const time = [];
            const origData = [];
            const filtData = [];
            
            for (let i = 0; i < original.length; i += step) {
                time.push((i / sampleRate).toFixed(3));
                origData.push(original[i]);
                filtData.push(filtered[i]);
            }
            
            window.waveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: time,
                    datasets: [{
                        label: 'Original Signal',
                        data: origData,
                        borderColor: 'rgb(76, 175, 80)',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0
                    }, {
                        label: 'Filtrlangan Signal',
                        data: filtData,
                        borderColor: 'rgb(183, 28, 28)',
                        backgroundColor: 'rgba(183, 28, 28, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 3,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Vaqt bo\'yicha Signal',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Vaqt (sekund)' }
                        },
                        y: {
                            title: { display: true, text: 'Amplituda' }
                        }
                    }
                }
            });
        }

        function drawSpectrum(original, filtered) {
            const canvas = document.getElementById('spectrumChart');
            const ctx = canvas.getContext('2d');
            
            if (window.specChart) window.specChart.destroy();
            
            const origFFT = computeFFT(original);
            const filtFFT = computeFFT(filtered);
            
            const freqs = [];
            const origMag = [];
            const filtMag = [];
            const step = Math.ceil(origFFT.length / 500);
            
            for (let i = 0; i < origFFT.length / 2; i += step) {
                freqs.push(((i / origFFT.length) * sampleRate).toFixed(0));
                const origDB = origFFT[i] > 0 ? 20 * Math.log10(origFFT[i]) : -100;
                const filtDB = filtFFT[i] > 0 ? 20 * Math.log10(filtFFT[i]) : -100;
                origMag.push(origDB);
                filtMag.push(filtDB);
            }
            
            window.specChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: freqs,
                    datasets: [{
                        label: 'Original Spektr',
                        data: origMag,
                        borderColor: 'rgb(76, 175, 80)',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0
                    }, {
                        label: 'Filtrlangan Spektr',
                        data: filtMag,
                        borderColor: 'rgb(183, 28, 28)',
                        backgroundColor: 'rgba(183, 28, 28, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 3,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Chastota Spektri',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Chastota (Hz)' }
                        },
                        y: {
                            title: { display: true, text: 'Magnit (dB)' }
                        }
                    }
                }
            });
        }

        function computeFFT(data) {
            const n = data.length;
            const magnitude = new Array(n).fill(0);
            
            for (let k = 0; k < n / 2; k++) {
                let real = 0, imag = 0;
                for (let t = 0; t < Math.min(n, 4096); t++) {
                    const angle = 2 * Math.PI * t * k / n;
                    real += data[t] * Math.cos(angle);
                    imag -= data[t] * Math.sin(angle);
                }
                magnitude[k] = Math.sqrt(real * real + imag * imag) / n;
            }
            
            return magnitude;
        }

        resetBtn.addEventListener('click', () => {
            audioChunks = [];
            audioBlob = null;
            originalAudioData = null;
            
            audioPlayerDiv.classList.add('hidden');
            filterSection.style.display = 'none';
            resultsSection.classList.remove('active');
            recordStatus.textContent = '⏳ Tayyor...';
            filterStatus.textContent = '⏳ Filtr parametrlarini tanlang...';
            
            if (window.waveChart) {
                window.waveChart.destroy();
                window.waveChart = null;
            }
            if (window.specChart) {
                window.specChart.destroy();
                window.specChart = null;
            }
            
            audioPlayer.src = '';
            document.getElementById('originalAudio').src = '';
            document.getElementById('filteredAudio').src = '';
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
        });
    </script>
</body>
</html>
